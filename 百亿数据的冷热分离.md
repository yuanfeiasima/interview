# 百亿数据的冷热分离

## 核心要点（面试快速回答）

**Q: 如何划分冷热数据？**
基于时间+状态+访问频率：热数据（30天内更新+在售，占50%，访问95%）；温数据（30-90天，占30%，访问4%）；冷数据（90天以上，占20%，访问1%）。

**Q: 三层存储架构是什么？**
在线库（热数据，256分库，SSD）、归档库（温数据，64分库，SSD）、对象存储（冷数据，OSS）。通过路由表（缓存在Redis）自动路由查询。

**Q: 归档如何保证安全？**
双写验证+软删除。写入归档库后立即校验，通过才删除在线库数据，且软删除保留7天可回滚。实际回滚率<0.1%。

**Q: 对性能和成本的影响？**
性能：P99延迟从150ms降到60ms，慢查询减少80%。成本：存储成本降低17.6%，计算成本降低10%，备份时间减半。

---

## 一、问题背景

### 1.1 数据规模现状

**商品数据统计：**
- 总数据量：100亿+
- 在线商品（活跃）：50亿
- 历史商品（已下架）：30亿
- 删除商品（软删除）：20亿
- 总存储：约 50TB

### 1.2 面临的核心问题

**1. 性能问题**
- 大量冷数据占用存储空间，导致索引膨胀
- 查询需要扫描更多数据，P99延迟从60ms升到150ms
- 备份恢复时间长（全量备份12小时）

**2. 成本问题**
- SSD存储成本高（1元/GB/月）
- 冷数据访问频率极低（< 1%），但占用50%存储
- 资源浪费严重，每月多花费数十万

**3. 运维问题**
- 数据库扩容困难（单库已达8000万）
- 备份窗口不够（业务24小时运行）
- 故障恢复慢（恢复8小时）

**结论：必须做冷热分离，否则系统无法持续发展。**

---

## 二、冷热数据划分策略

### 2.1 划分标准

**基于时间 + 状态 + 访问频率的多维度划分：**

**热数据（HOT）：**
- 近30天有更新
- 状态为在售
- 占比：50%
- 访问占比：95%

**温数据（WARM）：**
- 30-90天内有更新
- 或已下架但近期有访问
- 占比：30%
- 访问占比：4%

**冷数据（COLD）：**
- 90天以上无更新
- 无访问记录
- 占比：20%
- 访问占比：1%

### 2.2 为什么这样划分？

**考量因素：**
1. **业务特征**：外卖商品生命周期短，90天无更新基本不会再用
2. **访问模式**：用户主要浏览近期商品
3. **成本平衡**：热数据用SSD，冷数据用廉价存储

**实际数据验证：**
- 统计了3个月的访问日志
- 90天以上的商品访问量 < 1%
- 验证了划分标准的合理性

---

## 三、三层存储架构

### 3.1 架构设计

```
应用层（统一查询接口）
         ↓
路由层（根据商品ID判断数据温度）
    ↓        ↓        ↓
在线库    归档库    对象存储
(HOT)    (WARM)    (COLD)
256分库   64分库    OSS
SSD      SSD       廉价存储
```

### 3.2 为什么是三层？

**两层不够：**
- 如果只有热/冷两层，温数据放哪里？
- 温数据放热库，成本高
- 温数据放冷库，查询慢

**三层刚好：**
- 热数据：高性能SSD，256分库
- 温数据：普通SSD，64分库（成本降低）
- 冷数据：OSS对象存储（成本降低90%）

### 3.3 路由层设计

**核心思路：**
1. 维护一个路由表，记录每个商品的温度
2. 查询时先查路由表（缓存在Redis）
3. 根据温度路由到不同存储

**路由表设计：**
- 商品ID → 温度 + 分库索引
- 全部缓存在Redis（约10GB）
- 命中率99.9%

---


## 四、归档策略

### 4.1 自动归档流程

**定时任务：**
- 每天凌晨2点执行（业务低峰期）
- 扫描需要归档的数据
- 分批归档（每批1000条，避免影响线上）

### 4.2 归档详细步骤

**步骤：**
1. 从在线库查询待归档数据
2. 判断归档目标（温库 or 冷库）
3. 写入目标存储
4. 数据校验（完整性 + 一致性）
5. 更新路由表
6. 软删除在线库数据（保留7天，可回滚）
7. 7天后物理删除

### 4.3 归档安全保障

**双写验证机制：**
- 写入归档库后，立即读取验证
- 校验数据完整性（数量是否一致）
- 校验数据一致性（内容是否一致）
- 只有校验通过才删除在线库数据

**回滚机制：**
- 软删除保留7天
- 发现问题可以快速恢复
- 实际回滚率 < 0.1%

---


## 五、历史数据查询

### 5.1 统一查询接口

**设计原则：业务层无感知**

查询流程：
1. 先查缓存（Redis）
2. 未命中，查路由表
3. 根据温度路由到不同存储
4. 返回结果并缓存

**对业务的影响：**
- 热数据：延迟无变化（20ms）
- 温数据：延迟略增（50ms）
- 冷数据：延迟较高（200ms）

### 5.2 冷数据查询优化

**问题：OSS查询慢（RT 500ms+）**

**优化方案：**
1. **异步查询**：不阻塞主流程
2. **批量预加载**：预测用户可能查询的数据
3. **降级策略**：查询失败返回基础信息

**实际效果：**
- 冷数据查询延迟从500ms降到200ms
- 用户投诉率 < 0.01%

---


## 六、对在线系统的性能影响

### 6.1 性能提升

**实施冷热分离后的效果：**

**在线库数据量：**
- 分离前：100亿
- 分离后：50亿（减少50%）

**查询性能：**
- P99延迟：从 150ms 降到 60ms
- 平均延迟：从 50ms 降到 20ms
- 慢查询：减少 80%

### 6.2 索引优化

**数据量减少带来的索引优化：**
- 索引大小：从单库8GB降到4GB
- 更多索引可以常驻内存
- 减少磁盘IO
- 查询效率提升

### 6.3 备份恢复优化

**备份时间对比：**
- 全量备份：从12小时降到6小时（减少50%）
- 增量备份：从2小时降到40分钟
- 故障恢复：从8小时降到3小时

---


## 七、成本优化

### 7.1 存储成本对比

**成本分析：**

**分离前（全部SSD）：**
- 50TB × 1元/GB/月 = 50,000元/月

**分离后：**
- 热数据：25TB × 1元 = 25,000元/月
- 温数据：15TB × 1元 = 15,000元/月
- 冷数据：10TB × 0.12元 = 1,200元/月
- 总计：41,200元/月

**节省：8,800元/月（17.6%）**

### 7.2 计算资源优化

**数据库实例成本：**

**分离前：**
- 在线库：256个实例
- 成本：512,000元/月

**分离后：**
- 在线库：256个实例（规格降低20%）
- 归档库：64个实例（低配）
- 成本：460,800元/月

**节省：51,200元/月（10%）**

---


## 八、数据回温机制

### 8.1 什么是数据回温？

**场景：**
某些冷数据突然被频繁访问（比如商家重新上架历史商品），需要将其从冷存储迁移回热存储。

### 8.2 自动回温触发

**触发条件：**
- 1小时内访问超过10次
- 或商家主动申请回温

**回温流程：**
1. 从冷存储读取数据
2. 写入在线库
3. 更新路由表
4. 删除冷存储（可选）

**实际情况：**
- 回温频率：每天约100个商品
- 回温成功率：99.9%

---


## 九、监控与告警

### 9.1 关键指标监控

**数据量监控：**
- 热数据量：不超过60亿
- 温数据量：不超过40亿
- 冷数据量：持续增长

**归档速率：**
- 每天归档量：约500万
- 归档失败率：< 0.1%

**查询延迟：**
- 热数据：P99 < 100ms
- 温数据：P99 < 200ms
- 冷数据：P99 < 500ms

### 9.2 告警规则

**告警配置：**
- 热数据量超限：触发归档任务
- 归档失败率高：人工介入
- 冷数据查询慢：检查OSS服务

---


## 十、实施经验总结

### 10.1 关键成功因素

**1. 准确的冷热划分**
- 基于业务特征制定规则
- 持续监控和调整
- 避免误判导致性能问题

**2. 完善的数据校验**
- 归档前后数据一致性校验
- 定期全量对账
- 快速回滚机制

**3. 透明的查询接口**
- 业务层无感知
- 统一的查询入口
- 自动路由和降级


### 10.2 踩过的坑

**1. 归档过快导致误删**
- 问题：某些商品刚下架就被归档，商家投诉
- 解决：增加7天缓冲期

**2. 路由表缓存不一致**
- 问题：数据已归档，但路由表未更新
- 解决：归档和路由更新放在同一事务

**3. 冷数据查询超时**
- 问题：OSS查询慢，影响用户体验
- 解决：异步查询 + 降级策略

**4. 归档任务影响线上**
- 问题：归档任务占用数据库资源，影响线上查询
- 解决：限制归档速率，分批执行

### 10.3 最终效果

**性能提升：**
- P99延迟降低60%
- 慢查询减少80%

**成本节省：**
- 存储成本降低17.6%
- 计算成本降低10%

**运维改善：**
- 备份时间减半
- 扩容压力降低

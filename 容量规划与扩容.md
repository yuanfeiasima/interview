# 容量规划与扩容

## 核心要点（面试快速回答）

**Q: 容量规划怎么做？**
基于历史数据预测未来增长（月增长率8%），结合资源使用率监控（CPU<70%、磁盘<75%），提前3-6个月规划。预测6个月后从50亿商品增长到79亿，峰值QPS从100万到476万。

**Q: 什么时候扩容？**
硬性指标：CPU持续超70%、磁盘超75%、P99超200ms。软性指标：预测3个月后达到硬性指标、大促前1个月。

**Q: 分库扩容如何保证业务无感知？**
双写+灰度切流。新数据同时写256库和512库，历史数据异步迁移，通过配置中心控制灰度比例（1%→10%→50%→100%），每个阶段观察3天，发现问题立即回滚。耗时3个月，零故障。

**Q: 数据迁移方案？**
每天凌晨2-6点分批迁移，每批1000个商家，限速避免影响线上。迁移后立即校验，实时校验采样10%，全量校验每天凌晨执行。

---

## 一、容量规划的核心思路

### 1.1 为什么需要容量规划？

**4000+台服务器的集群规模，如果没有容量规划：**
- 突然发现容量不够，紧急扩容来不及
- 过度采购，资源浪费，成本高
- 性能瓶颈无法提前发现

**容量规划的目标：**
- 提前3-6个月预测容量需求
- 保证系统稳定运行
- 成本最优

### 1.2 容量规划的三个维度

**1. 业务增长预测**
- 基于历史数据预测未来增长
- 考虑大促、营销活动的影响
- 预留20-30%的缓冲

**2. 资源使用率监控**
- CPU、内存、磁盘、网络
- 数据库连接数、QPS
- 缓存命中率

**3. 性能指标**
- P99响应时间
- 错误率
- 可用性

---

## 二、容量评估方法

### 2.1 基于历史数据的容量预测

**数据收集：**
- 每天的订单量、商品数、QPS
- 每月的增长率
- 大促期间的峰值

**预测模型：**
```
未来容量 = 当前容量 × (1 + 月增长率)^月数 × 峰值系数
```

**实际案例：**
```
当前状态（2024年1月）：
- 日订单量：1.5亿
- 商品数：50亿
- 峰值QPS：100万

历史增长率：
- 月均增长：8%
- 大促峰值：平时的3倍

预测6个月后（2024年7月）：
- 日订单量：1.5亿 × 1.08^6 = 2.4亿
- 商品数：50亿 × 1.08^6 = 79亿
- 峰值QPS：100万 × 1.08^6 × 3 = 476万
```


### 2.2 资源使用率评估

**评估标准：**
- CPU使用率：< 70%（预留30%应对突发）
- 内存使用率：< 80%
- 磁盘使用率：< 75%
- 数据库连接数：< 80%

**为什么不能用满？**
- 需要预留缓冲应对突发流量
- 需要预留空间做故障切换
- 高负载下性能会急剧下降

**实际监控数据：**
```
当前状态（256个分库）：
- 平均CPU：60%
- 峰值CPU：85%（已接近阈值）
- 磁盘使用率：70%
- 单库数据量：平均2000万，最大5000万

结论：需要扩容
```

---


## 三、什么时候需要扩容？

### 3.1 扩容触发条件

**硬性指标（必须扩容）：**
1. CPU使用率持续超过70%
2. 磁盘使用率超过75%
3. P99响应时间超过SLA（200ms）
4. 错误率超过0.1%

**软性指标（建议扩容）：**
1. 预测3个月后达到硬性指标
2. 大促前1个月
3. 新业务上线前

### 3.2 扩容决策流程

**步骤：**
1. 监控系统发现指标异常
2. 分析是否是临时波动
3. 评估扩容成本和收益
4. 制定扩容方案
5. 申请资源
6. 执行扩容

**决策周期：**
- 紧急扩容：1周
- 常规扩容：1个月
- 大规模扩容：3个月

---


## 四、应用层扩容（相对简单）

### 4.1 扩容方式

**水平扩容：**
- 增加服务器数量
- 通过负载均衡分流
- 无状态服务，扩容简单

**扩容步骤：**
1. 申请新机器
2. 部署应用
3. 加入负载均衡
4. 灰度放量
5. 监控观察

**业务无感知：**
- 整个过程10分钟
- 用户无感知
- 可随时回滚


## 五、数据库扩容（最复杂）

### 5.1 分库分表扩容方案

**场景：从256库扩到512库**

**为什么要扩？**
- 单库数据量达到5000万，性能下降
- 预测6个月后达到8000万（极限）
- 必须提前扩容

**核心挑战：**
1. 数据迁移量大（50亿商品）
2. 不能停服
3. 数据一致性
4. 分片键变化（256 → 512）


### 5.2 扩容方案：双写 + 灰度切流

**整体方案（类似16库扩到256库）：**

```
阶段1：准备阶段（2周）
  - 搭建512个新库
  - 开发双写逻辑
  - 数据校验工具

阶段2：双写阶段（4周）
  - 新数据同时写256库和512库
  - 读取仍从256库读
  - 历史数据异步迁移

阶段3：灰度切流（4周）
  - 1% → 10% → 50% → 100%
  - 持续监控和校验

阶段4：清理（1周）
  - 停止双写
  - 下线256库
```


### 5.3 双写实现（核心代码）

```java
@Service
public class DualWriteService {
    private final ShardingStrategy oldStrategy;  // 256库
    private final ShardingStrategy newStrategy;  // 512库
    
    public void insert(Product product) {
        Long merchantId = product.getMerchantId();
        
        // 计算分片
        int oldShard = oldStrategy.getShard(merchantId);  // % 256
        int newShard = newStrategy.getShard(merchantId);  // % 512
        
        // 1. 先写老库（主路径）
        oldDao.insert(oldShard, product);
        
        // 2. 异步写新库
        asyncWriteNewDb(newShard, product);
    }
}
```


### 5.4 灰度切流实现（核心代码）

```java
@Service
public class GrayRouterService {
    
    public Product query(Long merchantId, Long productId) {
        // 根据灰度比例决定从哪个库读
        if (shouldReadFromNewDb(merchantId)) {
            int newShard = merchantId % 512;
            return newDao.query(newShard, productId);
        } else {
            int oldShard = merchantId % 256;
            return oldDao.query(oldShard, productId);
        }
    }
    
    private boolean shouldReadFromNewDb(Long merchantId) {
        int grayPercent = configCenter.getGrayPercent();  // 0-100
        return (merchantId % 100) < grayPercent;
    }
}
```

**灰度策略：**
- 按商家ID取模，保证同一商家始终路由到同一个库
- 通过配置中心动态调整灰度比例
- 发现问题可以快速回滚


### 5.5 数据迁移方案

**历史数据迁移：**
- 每天凌晨2-6点执行（业务低峰期）
- 分批迁移，每批1000个商家
- 限速，避免影响线上

**迁移流程：**
1. 从256库查询数据
2. 写入512库
3. 数据校验
4. 标记已迁移

**迁移进度：**
- 总商家数：500万
- 每天迁移：10万商家
- 预计耗时：50天


---

## 六、如何保证业务无感知

### 6.1 核心原则

**1. 双写保证数据完整**
- 新老库同时写入
- 以老库为准
- 新库失败不影响业务

**2. 灰度切流降低风险**
- 从1%开始，逐步放量
- 每个阶段观察3天
- 发现问题立即回滚

**3. 数据校验保证一致性**
- 实时校验（采样10%）
- 全量校验（每天凌晨）
- 不一致自动修复


### 6.2 监控指标

**扩容期间重点监控：**
- 双写成功率：> 99.9%
- 数据一致性：> 99.99%
- 查询延迟：P99 < 200ms
- 错误率：< 0.1%

**告警机制：**
- 双写失败率超过0.1%：立即告警
- 数据不一致超过100条：人工介入
- 查询延迟超过300ms：回滚灰度


---

## 七、缓存和ES的扩容

### 7.1 Redis集群扩容

**扩容方式：**
- Redis Cluster自动分片
- 增加节点，自动rebalance
- 业务无感知

**扩容步骤：**
1. 添加新节点到集群
2. 执行reshard命令
3. 数据自动迁移
4. 监控观察

**耗时：**
- 添加节点：10分钟
- 数据迁移：1-2小时
- 业务无影响


### 7.2 Elasticsearch扩容

**扩容方式：**
- 增加节点
- 自动rebalance分片
- 相对简单

**注意事项：**
- 扩容期间写入性能下降
- 建议在业务低峰期执行
- 提前调整副本数

---


## 八、成本优化

### 8.1 按需扩容 vs 提前采购

**按需扩容：**
- 优势：成本最优，不浪费
- 劣势：扩容周期长，可能来不及

**提前采购：**
- 优势：应对突发流量
- 劣势：资源闲置，成本高

**我们的策略：**
- 常规扩容：按需采购
- 大促前：提前1个月采购
- 预留20%缓冲


### 8.2 资源利用率优化

**混合部署：**
- 应用服务和缓存混部
- 提高资源利用率
- 节省成本约15%

**弹性伸缩：**
- 业务低峰期缩容
- 高峰期扩容
- 云上资源按需使用

---


## 九、实施经验总结

### 9.1 容量规划的关键

**1. 提前预测**
- 至少提前3个月
- 基于历史数据和业务规划
- 考虑大促等特殊场景

**2. 持续监控**
- 实时监控资源使用率
- 定期评估容量
- 及时发现瓶颈

**3. 灵活调整**
- 根据实际情况调整计划
- 不要过度采购
- 也不要等到最后一刻


### 9.2 扩容的关键

**1. 双写保证数据完整**
- 新老系统同时写入
- 以老系统为准
- 失败不影响业务

**2. 灰度降低风险**
- 小流量验证
- 逐步放量
- 快速回滚

**3. 充分测试**
- 压测验证性能
- 数据校验
- 故障演练


### 9.3 踩过的坑

**1. 扩容周期估计不足**
- 问题：以为1个月能完成，实际用了3个月
- 原因：数据迁移比预期慢，遇到各种问题
- 教训：预留足够的时间缓冲

**2. 灰度切流过快**
- 问题：从10%直接切到50%，发现大量问题
- 影响：部分用户查询失败
- 教训：灰度要循序渐进，每个阶段充分观察

**3. 数据校验不充分**
- 问题：切流后发现数据不一致
- 原因：只做了采样校验，没有全量校验
- 教训：全量校验必不可少


### 9.4 最终效果

**扩容效果：**
- 从256库扩到512库，耗时3个月
- 业务无感知，零故障
- 数据一致性99.99%

**容量提升：**
- 支持商品数从50亿提升到100亿
- 峰值QPS从100万提升到200万
- 预留未来2年的增长空间

**成本控制：**
- 按需采购，避免浪费
- 资源利用率从60%提升到75%
- 整体成本增长控制在50%以内

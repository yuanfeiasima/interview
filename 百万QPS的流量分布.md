# 百万QPS的流量分布

## 核心要点（面试快速回答）

**Q: 百万QPS是峰值还是平均值？**
百万QPS是峰值，出现在午高峰（11:30-13:00）和晚高峰（18:00-20:00）。日常平均QPS约20万，峰值是平均值的5倍。这个峰谷比决定了我们必须做弹性扩缩容，否则成本太高。

**Q: 流量的时间分布特征？**
典型双峰分布：午高峰占全天流量的35%，晚高峰占40%，其余时段占25%。晚高峰比午高峰高15%左右。周末流量比工作日高20%，节假日（如春节）流量翻倍。

**Q: 流量的空间分布特征？**
一线城市（北上广深）占40%流量，新一线城市占30%，其余城市占30%。但增速最快的是下沉市场（三四线城市），年增长率超过50%。

**Q: 这些特征如何影响架构设计？**
三个关键决策：1）SET化部署，按城市/区域划分，降低跨地域延迟；2）弹性扩缩容，高峰前30分钟自动扩容；3）分级限流，优先保障高流量区域的核心商家。

---

## 一、流量规模概览

### 1.1 核心指标

```
日请求量：约200亿次
峰值QPS：100万+
平均QPS：20万
峰谷比：5:1
日活商家：约500万
日活用户：约3000万
```

### 1.2 请求类型分布

| 接口类型 | QPS占比 | 峰值QPS | 特点 |
|---------|--------|---------|-----|
| 商品列表查询 | 45% | 45万 | 高频、批量查询 |
| 商品详情查询 | 30% | 30万 | 单品查询、热点集中 |
| 商品搜索 | 15% | 15万 | 计算密集 |
| 商品管理（B端）| 10% | 10万 | 写操作多 |

---

## 二、时间维度的流量分布

### 2.1 日内流量曲线

```
QPS
100万 |                    *****
      |                   *     *
 80万 |                  *       *
      |        ****     *         *
 60万 |       *    *   *           *
      |      *      * *             *
 40万 |     *        *               *
      |    *                          *
 20万 |***                             ****
      |________________________________
       6  8  10  12  14  16  18  20  22  24 (时)
              午高峰      晚高峰
```

**时段流量分布：**
- 早间（6:00-11:00）：15%，以早餐订单为主
- 午高峰（11:00-14:00）：35%，午餐场景
- 下午（14:00-17:00）：10%，下午茶、零食
- 晚高峰（17:00-21:00）：40%，晚餐场景，全天最高峰
- 夜间（21:00-6:00）：约5%，夜宵

### 2.2 周期性规律

**周内分布：**
- 工作日：相对平稳，周一到周五流量差异<5%
- 周末：流量比工作日高20%，峰值持续时间更长
- 周五晚上：全周最高峰，比普通工作日高30%

**月度/年度规律：**
- 月初发工资后3天：流量提升10%
- 节假日（春节、国庆）：流量翻倍
- 恶劣天气（雨雪）：流量激增50%-100%

### 2.3 突发流量场景

| 场景 | 流量倍数 | 持续时间 | 预警时间 |
|-----|---------|---------|---------|
| 常规大促 | 2-3倍 | 2-4小时 | 提前1周 |
| 恶劣天气 | 1.5-2倍 | 数小时 | 提前30分钟 |
| 热点事件 | 1.5倍 | 1-2小时 | 无法预警 |
| 故障恢复 | 3-5倍 | 10-30分钟 | 无法预警 |

---

## 三、空间维度的流量分布

### 3.1 城市层级分布

```
一线城市（北上广深）：
- 流量占比：40%
- 特点：成熟市场，增速放缓（10%/年）
- 峰值时间：更集中，峰谷比高

新一线城市（15个）：
- 流量占比：30%
- 特点：快速增长（25%/年）
- 代表城市：杭州、成都、武汉、南京

二三线城市：
- 流量占比：20%
- 特点：高速增长（40%/年）

四五线城市：
- 流量占比：10%
- 特点：爆发式增长（60%/年），下沉市场潜力大
```

### 3.2 地域流量特征差异

| 地域 | 午高峰占比 | 晚高峰占比 | 特点 |
|-----|----------|----------|-----|
| 北方城市 | 30% | 45% | 晚餐更重要 |
| 南方城市 | 35% | 38% | 午餐、夜宵都活跃 |
| 写字楼密集区 | 45% | 25% | 午餐刚需 |
| 住宅区 | 25% | 50% | 晚餐为主 |

### 3.3 热点区域识别

**热点判定标准：**
- 单商圈QPS > 1万
- 单商家QPS > 1000
- 持续时间 > 5分钟

**热点区域举例：**
- 北京中关村：午高峰单商圈QPS达5万
- 上海陆家嘴：午高峰单商圈QPS达4万
- 大学城区域：午晚高峰都是热点

---

## 四、流量特征对架构的影响

### 4.1 SET化部署

**为什么需要SET化？**
- 跨地域调用延迟高（北京到上海约30ms）
- 单机房故障影响范围大
- 不同地域流量特征不同，需要差异化配置

**SET划分策略：**
```
SET划分原则：
- 一线城市：独立SET（北京SET、上海SET、广州SET、深圳SET）
- 新一线城市：区域SET（华东SET、华中SET、西南SET）
- 其他城市：大区SET（华北大区、华南大区等）

每个SET内闭环：
- 独立的应用集群
- 独立的缓存集群
- 独立的数据库（分库分表后的部分库）
```

**SET化收益：**
- 延迟降低70%（P99从100ms降到30ms）
- 故障隔离，单SET故障不影响其他SET
- 可以按SET灰度发布

### 4.2 弹性扩缩容

**为什么需要弹性扩缩容？**
- 峰谷比5:1，如果按峰值配置，资源浪费80%
- 突发流量无法预测，固定容量无法应对

**扩缩容策略：**
```
触发条件：
- CPU使用率 > 70%，触发扩容
- CPU使用率 < 30%（持续10分钟），触发缩容
- QPS增长率 > 50%/分钟，触发紧急扩容

扩容方式：
- 常规扩容：基于容器化，2分钟完成扩容
- 紧急扩容：预热好的备用实例，30秒上线
- 预扩容：大促前1小时自动扩容到目标容量

缩容保护：
- 最小实例数：保留20%的峰值容量
- 缩容速度：每5分钟最多缩10%
- 缩容时间：避开高峰前1小时
```

**实际效果：**
- 资源利用率从30%提升到65%
- 年化成本节省约40%

### 4.3 分级限流

**为什么需要分级限流？**
- 不同区域的重要性不同（一线城市GMV占比高）
- 不同商家的重要性不同（头部商家贡献主要GMV）
- 一刀切限流会误伤核心用户

**分级策略：**
```
区域优先级：
- P0（一线城市核心商圈）：最后限流，限流阈值是普通区域的3倍
- P1（一线城市其他区域）：限流阈值是普通区域的2倍
- P2（新一线城市）：正常限流
- P3（其他城市）：优先限流

商家优先级：
- S级（头部商家）：限流阈值10000 QPS
- A级（重点商家）：限流阈值5000 QPS
- B级（普通商家）：限流阈值1000 QPS
- C级（长尾商家）：限流阈值100 QPS
```

---

## 五、流量预测与容量规划

### 5.1 流量预测模型

**预测维度：**
- 短期预测（未来1小时）：基于历史同期数据 + 实时趋势
- 中期预测（未来1周）：考虑节假日、活动、天气因素
- 长期预测（未来1年）：业务增长模型

**预测准确率：**
- 短期预测：准确率95%+
- 中期预测：准确率85%+
- 长期预测：准确率70%+

### 5.2 容量规划原则

```
核心原则：
1. 峰值容量 = 预测峰值QPS × 1.5（50%冗余）
2. 基础容量 = 日常平均QPS × 2（应对突发）
3. 弹性容量 = 峰值容量 - 基础容量（可快速扩容）

实际配置：
- 基础容量：40万QPS（约2000台机器）
- 弹性容量：80万QPS（约4000台机器，按需启用）
- 极限容量：150万QPS（大促专用，临时资源）
```

---

## 六、监控与可观测性

### 6.1 流量监控大盘

**核心指标：**
- 实时QPS（秒级刷新）
- 各SET流量分布
- 各接口流量分布
- 异常流量告警

### 6.2 告警规则

| 指标 | 告警阈值 | 响应级别 |
|-----|---------|---------|
| QPS突增 | >50%/分钟 | P1紧急 |
| 区域流量异常 | 偏离预测>30% | P2重要 |
| 单商家流量异常 | >10倍日常 | P2重要 |
| 容量水位 | >80% | P1紧急 |

---

## 七、经验总结

### 7.1 关键认知

1. **流量不是均匀分布的**：二八定律明显，20%的时间承载80%的流量
2. **突发流量是常态**：必须有应对机制，不能假设流量平稳
3. **地域差异很大**：不能用一套配置打天下

### 7.2 踩过的坑

**坑1：低估了峰谷比**
- 早期按平均流量配置容量
- 第一次大促直接被打挂
- 教训：必须按峰值设计，再做弹性优化

**坑2：忽视了地域差异**
- 统一的限流阈值导致一线城市体验差
- 核心城市的GMV损失明显
- 教训：必须分级分区治理

**坑3：扩容速度跟不上流量增长**
- 容器扩容需要2分钟
- 突发流量10秒就能把系统打爆
- 教训：必须有预热实例池，秒级扩容
